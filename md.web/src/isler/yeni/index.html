<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Yeni ƒ∞≈ü Ba≈ülat - ƒ∞≈ü Takip Paneli</title>
  <link rel="stylesheet" href="/assets/styles.css">
  <style>
    /* Wizard Styles */
    .wizard-container {
      max-width: 1100px;
      margin: 0 auto;
    }

    .wizard-stepper {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
      padding: 0 20px;
    }

    .wizard-stepper::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 50px;
      right: 50px;
      height: 2px;
      background: var(--color-border);
      z-index: 0;
    }

    .wizard-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
      z-index: 1;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .wizard-step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--color-white);
      border: 2px solid var(--color-border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: var(--color-text-light);
      margin-bottom: 8px;
      transition: all 0.3s ease;
    }

    .wizard-step.active .wizard-step-number {
      background: var(--color-primary);
      border-color: var(--color-primary);
      color: var(--color-white);
      transform: scale(1.15);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
    }

    .wizard-step.completed .wizard-step-number {
      background: var(--color-success);
      border-color: var(--color-success);
      color: var(--color-white);
    }

    .wizard-step.completed .wizard-step-number::before {
      content: '‚úì';
    }

    .wizard-step.disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .wizard-step-title {
      font-size: 12px;
      color: var(--color-text-light);
      text-align: center;
      max-width: 100px;
      line-height: 1.3;
    }

    .wizard-step.active .wizard-step-title {
      color: var(--color-primary);
      font-weight: 600;
    }

    .wizard-content {
      background: var(--color-white);
      border-radius: 12px;
      border: 1px solid var(--color-border);
      padding: 32px;
      min-height: 520px;
    }

    .wizard-step-content {
      display: none;
    }

    .wizard-step-content.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .wizard-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
      align-items: center;
      margin-top: 32px;
      padding: 16px 24px;
      border-top: 1px solid var(--color-border);
      position: sticky;
      bottom: 0;
      background: var(--color-white);
      z-index: 20;
    }

    .wizard-actions-left,
    .wizard-actions-center,
    .wizard-actions-right {
      display: flex;
      gap: 12px;
    }

    .step-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 8px;
      color: var(--color-text);
    }

    .step-subtitle {
      color: var(--color-text-light);
      margin-bottom: 24px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .form-error {
      color: var(--color-danger);
      font-size: 12px;
      margin-top: 4px;
      display: none;
    }

    .form-error.show {
      display: block;
    }

    .form-input.error,
    .form-select.error,
    .form-textarea.error {
      border-color: var(--color-danger);
    }

    .radio-group {
      display: flex;
      gap: 20px;
      margin-top: 8px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .product-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr 1fr auto;
      gap: 12px;
      align-items: end;
      margin-bottom: 12px;
      padding: 12px;
      background: var(--color-bg);
      border-radius: 8px;
    }

    .validation-message {
      background: rgba(220, 38, 38, 0.1);
      border-left: 4px solid var(--color-danger);
      padding: 12px 16px;
      border-radius: 6px;
      margin-bottom: 20px;
    }

    .validation-message ul {
      margin: 8px 0 0 20px;
      color: var(--color-danger);
      font-size: 14px;
    }

    .summary-section {
      margin-bottom: 24px;
      padding: 20px;
      background: var(--color-bg);
      border-radius: 8px;
    }

    .summary-section h4 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--color-primary);
    }

    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--color-border);
    }

    .summary-row:last-child {
      border-bottom: none;
    }

    .toast {
      position: fixed;
      top: 80px;
      right: 20px;
      background: var(--color-success);
      color: white;
      padding: 16px 24px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 10000;
      animation: slideIn 0.3s ease;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); }
      to { transform: translateX(0); }
    }

    .info-badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(37, 99, 235, 0.1);
      color: var(--color-primary);
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      margin-left: 8px;
    }

    .skeleton {
      background: linear-gradient(90deg, #f4f6f8 25%, #e9ecef 37%, #f4f6f8 63%);
      border-radius: 6px;
      background-size: 400% 100%;
      animation: skeleton-loading 1.4s ease infinite;
      height: 16px;
    }

    @keyframes skeleton-loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0 50%; }
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module" src="/assets/app.js"></script>
  <script type="module">
    /*********************************************************
     * CONFIG
     *********************************************************/
    const STORAGE_KEYS = {
      jobDraft: 'itp.newJobDraft.v1',
      purchaseDraft: 'itp.purchaseDraft.v1'
    };

    const FLOW = {
      MEASUREMENT_ONLY: 'MEASUREMENT_ONLY',
      DIRECT_QUOTE: 'DIRECT_QUOTE',
      SERVICE: 'SERVICE'
    };

    const JOB_STATUS = {
      MEASUREMENT_SCHEDULED: 'KE≈ûƒ∞F_PLANLANDI',
      SERVICE_OPEN: 'SERVIS_ACIK',
      READY_FOR_PRODUCTION: 'URETIME_HAZIR'
    };

    // Deterministic mock stok haritasƒ±
    const STOCK_MAP = {
      'pvc-80': 2,
      'pvc-70': 5,
      'door-steel': 0,
      'door-wooden': 1,
      'glass-balcony': 0,
      'mosquito-net': 20,
      'roller-shutter': 3,
      'manual-shutter': 6,
      'glass-4mm': 50,
      'glass-6mm': 10,
      'profile': 15,
      'handle': 30,
      'hinge': 12,
      'lock': 8,
      'silicone': 25
    };

    const ROUTES = {
      jobsList: '/isler/list/',
      jobDetail: (id) => id ? `/isler/${id}/` : null,
      calendar: '/isler/takvim/'
    };

    // Mock Customer Service (API-ready)
    const CustomerService = {
      customers: [
        { id: '1', name: 'Ahmet Yƒ±lmaz', type: 'individual' },
        { id: '2', name: 'Ay≈üe Demir', type: 'individual' },
        { id: '3', name: 'Mehmet Kaya', type: 'individual' },
        { id: '4', name: 'Fatma ≈ûahin', type: 'individual' },
        { id: '5', name: 'Can √ñzkan', type: 'individual' },
        { id: '6', name: 'ABC ≈ûirketi', type: 'corporate' },
        { id: '7', name: 'XYZ Ltd', type: 'corporate' },
        { id: '8', name: 'Yapƒ± A.≈û.', type: 'corporate' },
        { id: '9', name: 'ƒ∞n≈üaat Ltd', type: 'corporate' },
        { id: '10', name: 'Mimarlƒ±k Ofisi', type: 'corporate' }
      ],
      search(query) {
        if (!query) return this.customers;
        return this.customers.filter(c => c.name.toLowerCase().includes(query.toLowerCase()));
      },
      add(customer) {
        const id = String(Date.now());
        const newCustomer = { ...customer, id };
        this.customers.push(newCustomer);
        return newCustomer;
      }
    };

    const INITIAL_STATE = {
      currentStep: 1,
      completedSteps: [],
      loading: true,
      flow: FLOW.DIRECT_QUOTE,
      measurementStatus: 'NOT_NEEDED',
      jobId: null,
      formData: {
        // Step 1
        jobName: '',
        customerType: 'individual',
        customerId: '',
        jobCategory: '',
        priority: 'normal',
        jobSource: '',
        note: '',
        // Step 2
        needsSurvey: 'no',
        surveyDate: '',
        surveyResponsible: '',
        jobAddress: '',
        deadline: '',
        jobFiles: [],
        // Measurement / service
        surveyNotes: '',
        measurements: [],
        serviceNotes: '',
        serviceFiles: [],
        // Quote
        quoteItems: [],
        discountRate: 0,
        vatRate: 20,
        paymentType: 'cash',
        paymentNote: '',
        quoteStatus: 'DRAFT',
        quoteNote: '',
        quoteFile: null,
        // Products
        products: [],
        // Purchase
        needsPurchase: 'no',
        purchaseNote: '',
        supplierPreference: '',
        // Dates
        startDate: '',
        productionStart: '',
        installationDate: '',
        deliveryDate: '',
        deadlineCriticality: 'flexible',
        // Summary
        confirmed: false
      }
    };

    /*********************************************************
     * FLOW CONFIG
     *********************************************************/
    const STEP_DEFS = {
      base: {
        1: { id: 1, title: 'Temel Bilgiler' },
        2: { id: 2, title: 'ƒ∞≈ü Detaylarƒ±' },
        3: { id: 3, title: 'Ke≈üif Planlama' },
        4: { id: 4, title: 'Teklif/Fiyat' },
        5: { id: 5, title: '√úr√ºn Listesi' },
        6: { id: 6, title: 'Stok Kontrol√º' },
        7: { id: 7, title: 'Tarih Planƒ±' },
        8: { id: 8, title: '√ñzet' },
      },
      service: [
        { id: 1, title: 'Temel Bilgiler' },
        { id: 2, title: 'Servis Detayƒ±' },
        { id: 3, title: 'Servis Not & Dosya' },
        { id: 8, title: '√ñzet' },
      ],
      measurementOnly: [
        { id: 1, title: 'Temel Bilgiler' },
        { id: 2, title: 'ƒ∞≈ü Detaylarƒ±' },
        { id: 3, title: 'Ke≈üif Planlama + Dosya' },
        { id: 8, title: '√ñzet' },
      ],
      directQuote: [
        { id: 1, title: 'Temel Bilgiler' },
        { id: 2, title: 'ƒ∞≈ü Detaylarƒ±' },
        { id: 4, title: 'Teklif/Fiyatlandƒ±rma' },
        { id: 5, title: '√úr√ºn Listesi (BOM)' },
        { id: 6, title: 'Stok Kontrol√º' },
        { id: 7, title: 'Tarih Planƒ±' },
        { id: 8, title: '√ñzet' },
      ],
    };

    /*********************************************************
     * STATE
     *********************************************************/
    let wizardState = structuredClone(INITIAL_STATE);

    document.addEventListener('DOMContentLoaded', () => {
      loadDraft();
      resolveFlow();
      syncUrlStep();
      renderWizard();
    });

    function loadDraft() {
      const saved = localStorage.getItem(STORAGE_KEYS.jobDraft);
      if (saved) {
        try {
          wizardState = { ...wizardState, ...JSON.parse(saved), loading: false };
        } catch (e) {
          wizardState.loading = false;
        }
      } else {
        wizardState.loading = false;
      }
    }
    function saveDraft() { localStorage.setItem(STORAGE_KEYS.jobDraft, JSON.stringify(wizardState)); }
    function clearDraft() { localStorage.removeItem(STORAGE_KEYS.jobDraft); wizardState = structuredClone(INITIAL_STATE); wizardState.loading = false; }

    function savePurchaseDraft(items, supplierPreference, note) {
      const draft = {
        items,
        supplierPreferenceId: supplierPreference || '',
        note: note || '',
        createdAt: new Date().toISOString(),
        source: 'NEW_JOB_WIZARD'
      };
      localStorage.setItem(STORAGE_KEYS.purchaseDraft, JSON.stringify(draft));
    }

    /*********************************************************
     * FLOW RESOLUTION
     *********************************************************/
    function resolveFlow() {
      const d = wizardState.formData;
      if (d.jobCategory === 'service') {
        wizardState.flow = FLOW.SERVICE;
        return;
      }
      if (d.needsSurvey === 'yes') {
        // measurement not done yet
        wizardState.flow = FLOW.MEASUREMENT_ONLY;
      } else {
        wizardState.flow = FLOW.DIRECT_QUOTE;
      }
    }

    function getFlowSteps() {
      if (wizardState.flow === FLOW.SERVICE) return STEP_DEFS.service;
      if (wizardState.flow === FLOW.MEASUREMENT_ONLY) return STEP_DEFS.measurementOnly;
      return STEP_DEFS.directQuote;
    }

    function syncUrlStep() {
      const urlParams = new URLSearchParams(window.location.search);
      const param = urlParams.get('step');
      const steps = getFlowSteps().map(s => s.id);
      if (param && steps.includes(Number(param))) {
        wizardState.currentStep = Number(param);
      } else {
        wizardState.currentStep = steps[0];
      }
    }
    function updateUrl() {
      const url = new URL(window.location);
      url.searchParams.set('step', wizardState.currentStep);
      window.history.pushState({}, '', url);
    }

    /*********************************************************
     * RENDER
     *********************************************************/
    function renderWizard() {
      const pageContent = document.getElementById('pageContent');
      if (!pageContent) return;

      if (wizardState.loading) {
        pageContent.innerHTML = renderSkeleton();
        setTimeout(() => { wizardState.loading = false; renderWizard(); }, 200);
        return;
      }

      pageContent.innerHTML = `
        <div class="page-header">
          <div class="page-header-top">
            <h2 class="page-title">Yeni ƒ∞≈ü Ba≈ülat Wizard</h2>
            <div class="page-actions">
              <button class="btn btn-secondary" onclick="saveDraftAndShow()">üíæ Taslak Kaydet</button>
              <button class="btn btn-secondary" onclick="clearDraftAndRestart()">üóëÔ∏è Taslaƒüƒ± Sil</button>
            </div>
          </div>
          <p class="page-subtitle">Akƒ±≈ü: ${wizardState.flow}</p>
        </div>

        <div class="wizard-container">
          <div class="wizard-stepper">
            ${renderStepper()}
          </div>
          <div class="wizard-content">
            ${renderStepContent()}
            ${renderActions()}
          </div>
        </div>
      `;
    }

    function renderSkeleton() {
      return `
        <div class="card" style="padding:24px;">
          <div class="skeleton" style="width: 200px; height: 24px;"></div>
          <div style="margin-top:16px;" class="skeleton"></div>
          <div style="margin-top:8px;" class="skeleton"></div>
          <div style="margin-top:8px;" class="skeleton"></div>
          <div style="margin-top:24px;" class="skeleton" style="height:32px;"></div>
        </div>
      `;
    }

    function renderStepper() {
      const steps = getFlowSteps();
      return steps.map((s, idx) => {
        const active = s.id === wizardState.currentStep;
        const completed = wizardState.completedSteps.includes(s.id) || s.id < wizardState.currentStep;
        let cls = 'wizard-step';
        if (active) cls += ' active';
        if (completed) cls += ' completed';
        const clickable = completed || active;
        return `
          <div class="${cls}" ${clickable ? `onclick="goToStep(${s.id})"` : 'style="cursor:not-allowed;"'}>
            <div class="wizard-step-number">${idx + 1}</div>
            <div class="wizard-step-title">${s.title}</div>
          </div>
        `;
      }).join('');
    }

    function renderStepContent() {
      const step = wizardState.currentStep;
      const d = wizardState.formData;
      const flow = wizardState.flow;

      // SERVICE flow custom steps
      if (flow === FLOW.SERVICE) {
        if (step === 1) return renderStep1(d);
        if (step === 2) return renderServiceDetail(d);
        if (step === 3) return renderServiceNotes(d);
        if (step === 8) return renderSummaryStep(d);
      }

      // MEASUREMENT_ONLY flow
      if (flow === FLOW.MEASUREMENT_ONLY) {
        if (step === 1) return renderStep1(d);
        if (step === 2) return renderStep2(d, true);
        if (step === 3) return renderMeasurementPlan(d);
        if (step === 8) return renderSummaryStep(d, true);
      }

      // DIRECT_QUOTE flow
      switch (step) {
        case 1: return renderStep1(d);
        case 2: return renderStep2(d, false);
        case 4: return renderQuoteStep(d);
        case 5: return renderProductsStep(d);
        case 6: return renderStockStep(d);
        case 7: return renderDatesStep(d);
        case 8: return renderSummaryStep(d);
        default: return '<p>Adƒ±m bulunamadƒ±</p>';
      }
    }

    /*********************************************************
     * STEP RENDERERS
     *********************************************************/
    function renderStep1(d) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">Temel Bilgiler</h3>
          <p class="step-subtitle">ƒ∞≈üi kimin i√ßin ve hangi kategoride a√ßƒ±yoruz</p>
          <div id="validationErrors"></div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ƒ∞≈ü Adƒ± *</label>
              <input type="text" class="form-input" id="jobName" value="${d.jobName}" placeholder="√ñrn: Salon PVC Pencere" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">M√º≈üteri Tipi *</label>
            <div class="radio-group">
              <label class="radio-option"><input type="radio" name="customerType" value="individual" ${d.customerType === 'individual' ? 'checked' : ''} /> Bireysel</label>
              <label class="radio-option"><input type="radio" name="customerType" value="corporate" ${d.customerType === 'corporate' ? 'checked' : ''} /> Kurumsal</label>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">M√º≈üteri Se√ß *</label>
            <div style="display:flex; gap:8px;">
              <input type="text" class="form-input" id="customerSearch" placeholder="M√º≈üteri ara..." oninput="searchCustomer()" />
              <button class="btn btn-secondary" onclick="openCustomerModal()">+ Yeni M√º≈üteri</button>
            </div>
              <div id="customerResults" style="margin-top:8px;"></div>
              ${d.customerId ? `<div style="margin-top:8px; font-size:13px; color:var(--color-success);">Se√ßili m√º≈üteri: <strong>${getCustomerName(d.customerId)}</strong></div>` : ''}
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ƒ∞≈ü Kategorisi *</label>
              <select class="form-select" id="jobCategory" onchange="onCategoryChange(this.value)">
                <option value="">Kategori se√ßin...</option>
                <option value="pvc-window" ${d.jobCategory === 'pvc-window' ? 'selected' : ''}>PVC Pencere</option>
                <option value="door" ${d.jobCategory === 'door' ? 'selected' : ''}>Kapƒ±</option>
                <option value="glass-balcony" ${d.jobCategory === 'glass-balcony' ? 'selected' : ''}>Cam Balkon</option>
                <option value="mosquito" ${d.jobCategory === 'mosquito' ? 'selected' : ''}>Sineklik</option>
                <option value="shutter" ${d.jobCategory === 'shutter' ? 'selected' : ''}>Panjur</option>
                <option value="service" ${d.jobCategory === 'service' ? 'selected' : ''}>Servis</option>
                <option value="other" ${d.jobCategory === 'other' ? 'selected' : ''}>Diƒüer</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">√ñncelik *</label>
              <select class="form-select" id="priority">
                <option value="normal" ${d.priority === 'normal' ? 'selected' : ''}>Normal</option>
                <option value="high" ${d.priority === 'high' ? 'selected' : ''}>Y√ºksek</option>
                <option value="urgent" ${d.priority === 'urgent' ? 'selected' : ''}>Acil</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ƒ∞≈ü Kaynaƒüƒ±</label>
            <select class="form-select" id="jobSource">
              <option value="">Se√ßiniz...</option>
              <option value="reklam" ${d.jobSource === 'reklam' ? 'selected' : ''}>Reklam</option>
              <option value="referans" ${d.jobSource === 'referans' ? 'selected' : ''}>Referans</option>
              <option value="instagram" ${d.jobSource === 'instagram' ? 'selected' : ''}>Instagram</option>
              <option value="tabela" ${d.jobSource === 'tabela' ? 'selected' : ''}>Tabela</option>
              <option value="other" ${d.jobSource === 'other' ? 'selected' : ''}>Diƒüer</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Not</label>
            <textarea class="form-textarea" id="note" rows="3">${d.note || ''}</textarea>
          </div>
        </div>
      `;
    }

    function renderStep2(d, measurementMode) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">ƒ∞≈ü Detaylarƒ±</h3>
          <p class="step-subtitle">Adres ve ke≈üif gerekliliƒüi</p>
          <div id="validationErrors"></div>

          <div class="form-group">
            <label class="form-label">Ke≈üif/√ñl√ß√º gerekiyor mu? *</label>
            <div class="radio-group">
              <label class="radio-option"><input type="radio" name="needsSurvey" value="yes" ${d.needsSurvey === 'yes' ? 'checked' : ''} onchange="onSurveyChange('yes')" /> Evet</label>
              <label class="radio-option"><input type="radio" name="needsSurvey" value="no" ${d.needsSurvey === 'no' ? 'checked' : ''} onchange="onSurveyChange('no')" /> Hayƒ±r</label>
            </div>
          </div>

          <div id="surveyFields" style="display:${d.needsSurvey === 'yes' ? 'block' : 'none'};">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">Ke≈üif Tarihi ${d.needsSurvey === 'yes' ? '*' : ''}</label>
                <input type="date" class="form-input" id="surveyDate" value="${d.surveyDate || ''}" />
              </div>
              <div class="form-group">
                <label class="form-label">Ke≈üif Sorumlusu ${d.needsSurvey === 'yes' ? '*' : ''}</label>
                <select class="form-select" id="surveyResponsible">
                  <option value="">Se√ßiniz...</option>
                  <option value="mehmet" ${d.surveyResponsible === 'mehmet' ? 'selected' : ''}>Mehmet Usta</option>
                  <option value="ahmet" ${d.surveyResponsible === 'ahmet' ? 'selected' : ''}>Ahmet</option>
                  <option value="batuhan" ${d.surveyResponsible === 'batuhan' ? 'selected' : ''}>Batuhan</option>
                  <option value="other" ${d.surveyResponsible === 'other' ? 'selected' : ''}>Diƒüer</option>
                </select>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">ƒ∞≈ü Adresi *</label>
            <textarea class="form-textarea" id="jobAddress" rows="3">${d.jobAddress || ''}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Termin Beklentisi</label>
            <select class="form-select" id="deadline">
              <option value="">Se√ßiniz...</option>
              <option value="1-3" ${d.deadline === '1-3' ? 'selected' : ''}>1-3 g√ºn</option>
              <option value="3-7" ${d.deadline === '3-7' ? 'selected' : ''}>3-7 g√ºn</option>
              <option value="7-14" ${d.deadline === '7-14' ? 'selected' : ''}>7-14 g√ºn</option>
              <option value="14+" ${d.deadline === '14+' ? 'selected' : ''}>14+ g√ºn</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Dosya Y√ºkle (foto/pdf/dwg)</label>
            ${renderFileUpload('jobFiles', d.jobFiles)}
          </div>
        </div>
      `;
    }

    function renderMeasurementPlan(d) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">Ke≈üif Planlama + Dosya</h3>
          <p class="step-subtitle">Ke≈üif planƒ±nƒ± tamamlayƒ±n ve dosya ekleyin</p>
          <div id="validationErrors"></div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ke≈üif Tarihi *</label>
              <input type="date" class="form-input" id="surveyDate" value="${d.surveyDate || ''}" />
            </div>
            <div class="form-group">
              <label class="form-label">Ke≈üif Sorumlusu *</label>
              <select class="form-select" id="surveyResponsible">
                <option value="">Se√ßiniz...</option>
                <option value="mehmet" ${d.surveyResponsible === 'mehmet' ? 'selected' : ''}>Mehmet Usta</option>
                <option value="ahmet" ${d.surveyResponsible === 'ahmet' ? 'selected' : ''}>Ahmet</option>
                <option value="batuhan" ${d.surveyResponsible === 'batuhan' ? 'selected' : ''}>Batuhan</option>
                <option value="other" ${d.surveyResponsible === 'other' ? 'selected' : ''}>Diƒüer</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Ke≈üif Notu</label>
            <textarea class="form-textarea" id="surveyNotes" rows="3">${d.surveyNotes || ''}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Ke≈üif Dosyalarƒ±</label>
            ${renderFileUpload('jobFiles', d.jobFiles)}
          </div>
        </div>
      `;
    }

    function renderServiceDetail(d) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">Servis Detayƒ±</h3>
          <p class="step-subtitle">Servis nedenini ve adresi girin</p>
          <div id="validationErrors"></div>
          <div class="form-group">
            <label class="form-label">Servis Adresi *</label>
            <textarea class="form-textarea" id="jobAddress" rows="3">${d.jobAddress || ''}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Termin Beklentisi</label>
            <select class="form-select" id="deadline">
              <option value="">Se√ßiniz...</option>
              <option value="1-3" ${d.deadline === '1-3' ? 'selected' : ''}>1-3 g√ºn</option>
              <option value="3-7" ${d.deadline === '3-7' ? 'selected' : ''}>3-7 g√ºn</option>
              <option value="7-14" ${d.deadline === '7-14' ? 'selected' : ''}>7-14 g√ºn</option>
              <option value="14+" ${d.deadline === '14+' ? 'selected' : ''}>14+ g√ºn</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Servis Dosyalarƒ±</label>
            ${renderFileUpload('serviceFiles', d.serviceFiles)}
          </div>
        </div>
      `;
    }

    function renderServiceNotes(d) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">Servis Not & Dosya</h3>
          <p class="step-subtitle">Ek not ve dok√ºmanlarƒ± ekleyin</p>
          <div id="validationErrors"></div>
          <div class="form-group">
            <label class="form-label">Servis Notu</label>
            <textarea class="form-textarea" id="serviceNotes" rows="4">${d.serviceNotes || ''}</textarea>
          </div>
          <div class="form-group">
            <label class="form-label">Servis Dosyalarƒ±</label>
            ${renderFileUpload('serviceFiles', d.serviceFiles)}
          </div>
        </div>
      `;
    }

    function renderQuoteStep(d) {
      const items = (d.quoteItems || []).map((item, i) => `
        <div class="product-row" data-index="${i}">
          <input type="text" class="form-input" placeholder="Kalem adƒ±" value="${item.name || ''}" onchange="updateQuoteItem(${i}, 'name', this.value)" />
          <input type="number" class="form-input" placeholder="Tutar" value="${item.amount || 0}" onchange="updateQuoteItem(${i}, 'amount', this.value)" />
          <select class="form-select" onchange="updateQuoteItem(${i}, 'type', this.value)">
            <option value="material" ${item.type === 'material' ? 'selected' : ''}>Malzeme</option>
            <option value="labor" ${item.type === 'labor' ? 'selected' : ''}>ƒ∞≈ü√ßilik</option>
            <option value="install" ${item.type === 'install' ? 'selected' : ''}>Montaj</option>
            <option value="shipping" ${item.type === 'shipping' ? 'selected' : ''}>Nakliye</option>
            <option value="other" ${item.type === 'other' ? 'selected' : ''}>Diƒüer</option>
          </select>
          <input type="text" class="form-input" placeholder="Not" value="${item.note || ''}" onchange="updateQuoteItem(${i}, 'note', this.value)" />
          <button class="btn btn-secondary btn-icon" onclick="removeQuoteItem(${i})">üóëÔ∏è</button>
        </div>
      `).join('');

      const subtotal = (d.quoteItems || []).reduce((sum, it) => sum + (Number(it.amount) || 0), 0);
      const discount = subtotal * (Number(d.discountRate || 0) / 100);
      const taxedBase = subtotal - discount;
      const vat = taxedBase * (Number(d.vatRate || 0) / 100);
      const total = taxedBase + vat;

      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">Teklif / Fiyatlandƒ±rma & Anla≈üma</h3>
          <p class="step-subtitle">Teklif onaylanmadan BOM/Stok adƒ±mlarƒ±na ge√ßilemez</p>
          <div id="validationErrors"></div>

          <div class="form-group">
            <label class="form-label">Teklif Kalemleri</label>
            <div id="quoteItemsList">${items || '<p style="color:var(--color-text-light);">Kalem ekleyin</p>'}</div>
            <button class="btn btn-secondary" onclick="addQuoteItem()" style="margin-top:12px;">+ Kalem Ekle</button>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">ƒ∞skonto (%)</label>
              <input type="number" class="form-input" id="discountRate" value="${d.discountRate || 0}" min="0" max="100" />
            </div>
            <div class="form-group">
              <label class="form-label">KDV (%)</label>
              <input type="number" class="form-input" id="vatRate" value="${d.vatRate || 20}" min="0" max="100" />
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">√ñdeme Tipi</label>
              <select class="form-select" id="paymentType">
                <option value="cash" ${d.paymentType === 'cash' ? 'selected' : ''}>Nakit</option>
                <option value="deposit" ${d.paymentType === 'deposit' ? 'selected' : ''}>Kapora</option>
                <option value="installment" ${d.paymentType === 'installment' ? 'selected' : ''}>Vade</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">√ñdeme Notu</label>
              <input type="text" class="form-input" id="paymentNote" value="${d.paymentNote || ''}" />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Teklif Notu</label>
            <textarea class="form-textarea" id="quoteNote" rows="3">${d.quoteNote || ''}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label">Teklif Dosyasƒ± (PDF)</label>
            ${renderSingleFileUpload('quoteFile', d.quoteFile)}
          </div>

          <div class="card" style="margin-top:16px;">
            <div class="summary-row"><span>Alt toplam</span><strong>${subtotal.toFixed(2)} ‚Ç∫</strong></div>
            <div class="summary-row"><span>ƒ∞skonto (${d.discountRate || 0}%)</span><strong>-${discount.toFixed(2)} ‚Ç∫</strong></div>
            <div class="summary-row"><span>KDV (${d.vatRate || 0}%)</span><strong>${vat.toFixed(2)} ‚Ç∫</strong></div>
            <div class="summary-row"><span>Genel Toplam</span><strong>${total.toFixed(2)} ‚Ç∫</strong></div>
          </div>

          <div class="form-group" style="margin-top:12px;">
            <label class="form-label">Teklif Durumu</label>
            <select class="form-select" id="quoteStatus" onchange="onQuoteStatusChange(this.value)">
              <option value="DRAFT" ${d.quoteStatus === 'DRAFT' ? 'selected' : ''}>Taslak</option>
              <option value="PREPARED" ${d.quoteStatus === 'PREPARED' ? 'selected' : ''}>Hazƒ±rlandƒ±</option>
              <option value="APPROVED" ${d.quoteStatus === 'APPROVED' ? 'selected' : ''}>Onaylandƒ±</option>
              <option value="REJECTED" ${d.quoteStatus === 'REJECTED' ? 'selected' : ''}>Red</option>
            </select>
            <div class="info-badge">Onay olmadan BOM/Stok/Tarih step‚Äôleri a√ßƒ±lamaz</div>
          </div>
        </div>
      `;
    }

    function renderProductsStep(d) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">√úr√ºn Listesi (BOM)</h3>
          <p class="step-subtitle">Teklif onaylandƒ±ysa √ºr√ºnleri ekleyin</p>
          <div id="validationErrors"></div>
          <div id="productsList">
            ${(d.products || []).map((p, i) => `
              <div class="product-row">
                <select class="form-select" onchange="updateProduct(${i}, 'name', this.value)">
                  <option value="">√úr√ºn se√ßin...</option>
                  ${productOptions(p.name)}
                </select>
                <select class="form-select" onchange="updateProduct(${i}, 'unit', this.value)">
                  <option value="adet" ${p.unit === 'adet' ? 'selected' : ''}>Adet</option>
                  <option value="metre" ${p.unit === 'metre' ? 'selected' : ''}>Metre</option>
                  <option value="m2" ${p.unit === 'm2' ? 'selected' : ''}>m¬≤</option>
                  <option value="set" ${p.unit === 'set' ? 'selected' : ''}>Set</option>
                  <option value="kg" ${p.unit === 'kg' ? 'selected' : ''}>kg</option>
                  <option value="lt" ${p.unit === 'lt' ? 'selected' : ''}>lt</option>
                </select>
                <input type="number" class="form-input" value="${p.quantity || 0}" min="1" onchange="updateProduct(${i}, 'quantity', this.value)" />
                <input type="text" class="form-input" value="${p.note || ''}" onchange="updateProduct(${i}, 'note', this.value)" />
                <button class="btn btn-secondary btn-icon" onclick="removeProduct(${i})">üóëÔ∏è</button>
              </div>
            `).join('') || '<p style="color:var(--color-text-light);">√úr√ºn ekleyin</p>'}
          </div>
          <button class="btn btn-secondary" onclick="addProduct()" style="margin-top:12px;">+ √úr√ºn Ekle</button>
          <div class="form-error" id="products-error">En az 1 √ºr√ºn eklenmeli</div>
        </div>
      `;
    }

    function renderStockStep(d) {
      const rows = (d.products || []).map(p => {
        const st = mockStockStatus(p);
        return `<tr><td>${getProductName(p.name)}</td><td>${p.quantity} ${p.unit}</td><td>${st.stock} ${p.unit}</td><td><span class="badge badge-${st.badge}">${st.label}</span></td></tr>`;
      }).join('');
      const missing = (d.products || []).some(p => mockStockStatus(p).label === 'Yok');
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">Stok Kontrol√º</h3>
          <p class="step-subtitle">Eksik stok varsa satƒ±nalma talebi a√ßƒ±lmalƒ±</p>
          <div id="validationErrors"></div>
          ${(d.products || []).length ? `
            <div class="card" style="margin-bottom:12px;">
              <table class="table">
                <thead><tr><th>√úr√ºn</th><th>ƒ∞stenen</th><th>Stokta</th><th>Durum</th></tr></thead>
                <tbody>${rows}</tbody>
              </table>
            </div>
          ` : '<p style="color:var(--color-text-light);">√ñnce √ºr√ºn ekleyin</p>'}
          ${missing ? `
            <div class="validation-message">Eksik stok var. Satƒ±nalma talebi olu≈üturulmadan ilerlenemez.</div>
            <div style="display:flex; flex-direction:column; gap:12px; margin-top:12px; border:1px solid var(--color-border); padding:12px; border-radius:8px;">
              <div class="form-group" style="margin:0;">
                <label class="form-label">Satƒ±nalma Notu *</label>
                <textarea class="form-textarea" id="purchaseNote" rows="2">${d.purchaseNote || ''}</textarea>
              </div>
              <div class="form-group" style="margin:0;">
                <label class="form-label">Tedarik√ßi Tercihi</label>
                <select class="form-select" id="supplierPreference">
                  <option value="">Se√ßiniz...</option>
                  <option value="supplier1" ${d.supplierPreference === 'supplier1' ? 'selected' : ''}>Tedarik√ßi A</option>
                  <option value="supplier2" ${d.supplierPreference === 'supplier2' ? 'selected' : ''}>Tedarik√ßi B</option>
                  <option value="supplier3" ${d.supplierPreference === 'supplier3' ? 'selected' : ''}>Tedarik√ßi C</option>
                </select>
              </div>
              <div style="display:flex; gap:8px;">
                <button class="btn btn-primary" onclick="createPurchaseDraft()">Satƒ±nalma Talebi Olu≈ütur</button>
                <button class="btn btn-secondary" onclick="markPurchaseNeeded()">Satƒ±nalma Yapƒ±lacak</button>
              </div>
            </div>
          ` : '<p style="color:var(--color-success);">T√ºm √ºr√ºnler stokta yeterli g√∂r√ºn√ºyor.</p>'}
        </div>
      `;
    }

    function renderDatesStep(d) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">Tarih Planƒ±</h3>
          <p class="step-subtitle">√úretim / montaj / teslim planƒ±</p>
          <div id="validationErrors"></div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Ba≈ülangƒ±√ß Tarihi *</label>
              <input type="date" class="form-input" id="startDate" value="${d.startDate || ''}" />
            </div>
            <div class="form-group">
              <label class="form-label">Tahmini √úretim Ba≈ülangƒ±√ß</label>
              <input type="date" class="form-input" id="productionStart" value="${d.productionStart || ''}" />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Tahmini Montaj/Sevkiyat</label>
              <input type="date" class="form-input" id="installationDate" value="${d.installationDate || ''}" />
            </div>
            <div class="form-group">
              <label class="form-label">Tahmini Teslim</label>
              <input type="date" class="form-input" id="deliveryDate" value="${d.deliveryDate || ''}" />
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">Termin Kritiklik</label>
            <select class="form-select" id="deadlineCriticality">
              <option value="flexible" ${d.deadlineCriticality === 'flexible' ? 'selected' : ''}>Esnek</option>
              <option value="medium" ${d.deadlineCriticality === 'medium' ? 'selected' : ''}>Orta</option>
              <option value="strict" ${d.deadlineCriticality === 'strict' ? 'selected' : ''}>Sert</option>
            </select>
          </div>
        </div>
      `;
    }

    function renderSummaryStep(d, measurementOnly = false) {
      return `
        <div class="wizard-step-content active">
          <h3 class="step-title">√ñzet</h3>
          <p class="step-subtitle">${measurementOnly ? 'Ke≈üif planƒ±nƒ± tamamlayƒ±n' : 'ƒ∞≈ü kaydƒ±nƒ± onaylayƒ±n'}</p>
          <div id="validationErrors"></div>
          ${renderSummaryCards(d)}
          <div class="form-group" style="margin-top:16px;">
            <label class="radio-option" style="padding:14px; background:var(--color-bg); border-radius:8px; display:flex; gap:8px;">
              <input type="checkbox" id="confirmed" ${d.confirmed ? 'checked' : ''} />
              <span>Bilgileri onaylƒ±yorum *</span>
            </label>
          </div>
        </div>
      `;
    }

    function renderSummaryCards(d) {
      return `
        <div class="summary-section">
          <h4>üìã Temel Bilgiler</h4>
          <div class="summary-row"><span>ƒ∞≈ü Adƒ±</span><strong>${d.jobName || '-'}</strong></div>
          <div class="summary-row"><span>M√º≈üteri Tipi</span><strong>${d.customerType === 'individual' ? 'Bireysel' : 'Kurumsal'}</strong></div>
          <div class="summary-row"><span>Kategori</span><strong>${getCategoryName(d.jobCategory)}</strong></div>
          <div class="summary-row"><span>√ñncelik</span><strong>${d.priority}</strong></div>
        </div>
        <div class="summary-section">
          <h4>üìç Detay</h4>
          <div class="summary-row"><span>Ke≈üif Gerekli</span><strong>${d.needsSurvey === 'yes' ? 'Evet' : 'Hayƒ±r'}</strong></div>
          <div class="summary-row"><span>Adres</span><strong>${d.jobAddress || '-'}</strong></div>
          ${d.surveyDate ? `<div class="summary-row"><span>Ke≈üif Tarihi</span><strong>${d.surveyDate}</strong></div>` : ''}
        </div>
      `;
    }

    /*********************************************************
     * FILE RENDERERS
     *********************************************************/
    function renderFileUpload(key, files = []) {
      const rows = (files || []).map((f, i) => `
        <div style="display:flex; align-items:center; gap:10px; margin-top:8px;">
          <div style="width:44px; height:44px; border:1px solid var(--color-border); border-radius:8px; display:flex; align-items:center; justify-content:center; background:var(--color-bg);">
            ${f.type?.startsWith('image/') ? `<img src="${f.previewUrl}" style="max-width:100%; max-height:100%; border-radius:6px;" />` : 'üìÑ'}
          </div>
          <div style="flex:1;">
            <div style="font-weight:600;">${f.name}</div>
            <div style="font-size:12px; color:var(--color-text-light);">${(f.size/1024).toFixed(1)} KB</div>
          </div>
          <button class="btn btn-secondary btn-icon" onclick="removeFile('${key}', ${i})">üóëÔ∏è</button>
        </div>
      `).join('');
      return `
        <div style="border:1px dashed var(--color-border); padding:12px; border-radius:8px; background:var(--color-bg);">
          <input type="file" multiple accept="image/*,application/pdf,.dwg" onchange="handleFiles('${key}', event)" />
          ${rows || '<div style="color:var(--color-text-light); margin-top:6px;">Dosya yok</div>'}
        </div>
      `;
    }
    function renderSingleFileUpload(key, file) {
      if (!file) return '<div style="border:1px dashed var(--color-border); padding:12px; border-radius:8px; background:var(--color-bg);"><input type="file" accept="application/pdf" onchange="handleSingleFile(\''+key+'\', event)" /></div>';
      return `
        <div style="border:1px dashed var(--color-border); padding:12px; border-radius:8px; background:var(--color-bg);">
          <input type="file" accept="application/pdf" onchange="handleSingleFile('${key}', event)" />
          <div style="display:flex; align-items:center; gap:8px; margin-top:8px;">
            üìÑ <span>${file.name}</span>
            <button class="btn btn-secondary btn-icon" onclick="removeSingleFile('${key}')">üóëÔ∏è</button>
          </div>
        </div>
      `;
    }

    /*********************************************************
     * ACTION BAR
     *********************************************************/
    function renderActions() {
      const steps = getFlowSteps().map(s => s.id);
      const first = steps[0], last = steps[steps.length - 1];
      const isFirst = wizardState.currentStep === first;
      const isLast = wizardState.currentStep === last;
      return `
        <div class="wizard-actions">
          <div class="wizard-actions-left">
            <a href="/dashboard/" class="btn btn-secondary">ƒ∞ptal</a>
          </div>
          <div class="wizard-actions-center">
            ${!isFirst ? '<button class="btn btn-secondary" onclick="prevStep()">‚Üê Geri</button>' : ''}
          </div>
          <div class="wizard-actions-right" style="justify-content:flex-end;">
            ${!isLast ? '<button class="btn btn-primary" onclick="nextStep()">ƒ∞leri ‚Üí</button>' : ''}
            ${isLast ? '<button class="btn btn-primary" onclick="submitJob()">ƒ∞≈üi Olu≈ütur</button>' : ''}
          </div>
        </div>
      `;
    }

    /*********************************************************
     * NAVIGATION
     *********************************************************/
    window.nextStep = function() {
      saveCurrentStep();
      if (!validateStep(wizardState.currentStep)) return;
      if (!wizardState.completedSteps.includes(wizardState.currentStep)) wizardState.completedSteps.push(wizardState.currentStep);
      const steps = getFlowSteps().map(s => s.id);
      const idx = steps.indexOf(wizardState.currentStep);
      if (idx < steps.length - 1) wizardState.currentStep = steps[idx + 1];
      saveDraft(); updateUrl(); renderWizard(); window.scrollTo(0,0);
    };
    window.prevStep = function() {
      saveCurrentStep();
      const steps = getFlowSteps().map(s => s.id);
      const idx = steps.indexOf(wizardState.currentStep);
      if (idx > 0) wizardState.currentStep = steps[idx - 1];
      saveDraft(); updateUrl(); renderWizard(); window.scrollTo(0,0);
    };
    window.goToStep = function(target) {
      const steps = getFlowSteps().map(s => s.id);
      const curIdx = steps.indexOf(wizardState.currentStep);
      const tgtIdx = steps.indexOf(target);
      if (tgtIdx === -1) return;
      if (tgtIdx <= curIdx) { wizardState.currentStep = target; updateUrl(); renderWizard(); return; }
      showToast('L√ºtfen adƒ±mlarƒ± sƒ±rayla tamamlayƒ±n', 'warning');
    };

    window.saveDraftAndShow = function() { saveCurrentStep(); saveDraft(); showToast('Taslak kaydedildi', 'success'); };
    window.clearDraftAndRestart = function() { if (confirm('Taslak silinsin mi?')) { clearDraft(); resolveFlow(); updateUrl(); renderWizard(); showToast('Taslak silindi', 'success'); } };

    window.submitJob = function() {
      saveCurrentStep();
      if (!validateStep(wizardState.currentStep)) return;
      const flow = wizardState.flow;
      const status = flow === FLOW.MEASUREMENT_ONLY ? JOB_STATUS.MEASUREMENT_SCHEDULED
                    : flow === FLOW.SERVICE ? JOB_STATUS.SERVICE_OPEN
                    : JOB_STATUS.READY_FOR_PRODUCTION;
      console.log('üìù JOB SUBMIT', { status, data: wizardState.formData });
      clearDraft();
      showToast(flow === FLOW.MEASUREMENT_ONLY ? 'Ke≈üif planlandƒ±' : 'ƒ∞≈ü ba≈üarƒ±yla olu≈üturuldu!', 'success');
      setTimeout(() => {
        if (flow === FLOW.MEASUREMENT_ONLY) {
          window.location.href = ROUTES.calendar || ROUTES.jobsList;
        } else {
          window.location.href = ROUTES.jobsList;
        }
      }, 1200);
    };

    /*********************************************************
     * VALIDATION
     *********************************************************/
    function validateStep(step) {
      const d = wizardState.formData;
      const errors = [];
      const push = (m) => errors.push(m);
      const flow = wizardState.flow;

      if (step === 1) {
        if (!d.jobName.trim()) push('ƒ∞≈ü adƒ± zorunludur');
        if (!d.customerId) push('M√º≈üteri se√ßimi zorunludur');
        if (!d.jobCategory) push('Kategori zorunlu');
      }
      if (step === 2) {
        if (!d.jobAddress.trim()) push('Adres zorunlu');
        if (d.needsSurvey === 'yes') {
          if (!d.surveyDate) push('Ke≈üif tarihi zorunlu');
          if (!d.surveyResponsible) push('Ke≈üif sorumlusu zorunlu');
        }
      }

      if (flow === FLOW.MEASUREMENT_ONLY && step === 3) {
        if (!d.surveyDate) push('Ke≈üif tarihi zorunlu');
        if (!d.surveyResponsible) push('Ke≈üif sorumlusu zorunlu');
      }

      if (flow === FLOW.DIRECT_QUOTE) {
        if (step === 4) {
          if ((d.quoteItems || []).length === 0) push('En az 1 teklif kalemi ekleyin');
          if (d.quoteStatus !== 'APPROVED') push('Teklif onaylanmadan ilerlenemez');
        }
        if (step === 5) {
          if (d.quoteStatus !== 'APPROVED') push('Teklif onaylanmadan √ºr√ºn listesi a√ßƒ±lamaz');
          if ((d.products || []).length === 0) push('En az 1 √ºr√ºn eklenmeli');
        }
        if (step === 6) {
          const missing = (d.products || []).some(p => mockStockStatus(p).label === 'Yok');
          if (missing && d.needsPurchase === 'no') push('Eksik stok var, satƒ±nalma talebi a√ßƒ±lmalƒ±');
          if (d.needsPurchase === 'yes' && !d.purchaseNote.trim()) push('Satƒ±nalma notu zorunlu');
        }
        if (step === 7) {
          if (!d.startDate) push('Ba≈ülangƒ±√ß tarihi zorunlu');
          if (d.deliveryDate && d.startDate && d.deliveryDate < d.startDate) push('Teslim tarihi ba≈ülangƒ±√ßtan √∂nce olamaz');
        }
        if (step === 8) {
          if (!d.confirmed) push('Bilgileri onaylamalƒ±sƒ±nƒ±z');
        }
      }

      if (errors.length) { showValidationErrors(errors); return false; }
      hideValidationErrors(); return true;
    }
    function showValidationErrors(errors) {
      const el = document.getElementById('validationErrors');
      if (!el) return;
      el.innerHTML = `<div class="validation-message"><strong>‚ö†Ô∏è D√ºzeltin:</strong><ul>${errors.map(e=>`<li>${e}</li>`).join('')}</ul></div>`;
    }
    function hideValidationErrors() { const el = document.getElementById('validationErrors'); if (el) el.innerHTML = ''; }

    /*********************************************************
     * DATA SAVE
     *********************************************************/
    function saveCurrentStep() {
      const d = wizardState.formData;
      const s = wizardState.currentStep;
      if (s === 1) {
        d.jobName = val('#jobName'); d.customerType = radio('customerType') || 'individual';
        d.jobCategory = val('#jobCategory'); d.priority = val('#priority') || 'normal';
        d.jobSource = val('#jobSource') || ''; d.note = val('#note') || '';
      }
      if (s === 2) {
        d.needsSurvey = radio('needsSurvey') || 'no';
        d.surveyDate = val('#surveyDate'); d.surveyResponsible = val('#surveyResponsible');
        d.jobAddress = val('#jobAddress'); d.deadline = val('#deadline');
      }
      if (wizardState.flow === FLOW.MEASUREMENT_ONLY && s === 3) {
        d.surveyDate = val('#surveyDate'); d.surveyResponsible = val('#surveyResponsible');
        d.surveyNotes = val('#surveyNotes');
      }
      if (wizardState.flow === FLOW.SERVICE && s === 3) { d.serviceNotes = val('#serviceNotes'); }
      if (s === 4) {
        d.discountRate = Number(val('#discountRate') || 0);
        d.vatRate = Number(val('#vatRate') || 20);
        d.paymentType = val('#paymentType') || 'cash';
        d.paymentNote = val('#paymentNote') || '';
        d.quoteNote = val('#quoteNote') || '';
      }
      if (s === 6) {
        d.needsPurchase = radio('needsPurchase') || 'no';
        d.purchaseNote = val('#purchaseNote') || '';
        d.supplierPreference = val('#supplierPreference') || '';
      }
      if (s === 7) {
        d.startDate = val('#startDate'); d.productionStart = val('#productionStart');
        d.installationDate = val('#installationDate'); d.deliveryDate = val('#deliveryDate');
        d.deadlineCriticality = val('#deadlineCriticality') || 'flexible';
      }
      if (s === 8) { d.confirmed = document.getElementById('confirmed')?.checked || false; }
    }

    /*********************************************************
     * HELPERS
     *********************************************************/
    function val(sel){const el=document.querySelector(sel);return el?el.value:'';}
    function radio(name){const el=document.querySelector(`input[name=\"${name}\"]:checked`);return el?el.value:'';}
    function mockStockStatus(p){
      const stock = STOCK_MAP[p.name] !== undefined ? STOCK_MAP[p.name] : 10;
      const qty = Number(p.quantity || 0);
      if (stock === 0) return { stock, label: 'Yok', badge: 'danger' };
      if (stock < qty) return { stock, label: 'Kritik', badge: 'warning' };
      return { stock, label: 'Yeterli', badge: 'success' };
    }
    function productOptions(selected){return [
      {id:'pvc-80',name:'PVC Pencere 80mm'},{id:'pvc-70',name:'PVC Pencere 70mm'},
      {id:'door-steel',name:'√áelik Kapƒ±'},{id:'door-wooden',name:'Ah≈üap Kapƒ±'},
      {id:'glass-balcony',name:'Cam Balkon Sistemi'},{id:'mosquito-net',name:'Sineklik'},
      {id:'roller-shutter',name:'Motorlu Panjur'},{id:'manual-shutter',name:'Manuel Panjur'},
      {id:'glass-4mm',name:'Cam 4mm'},{id:'glass-6mm',name:'Cam 6mm'},
      {id:'profile',name:'Profil'},{id:'handle',name:'Kol'},{id:'hinge',name:'Mente≈üe'},
      {id:'lock',name:'Kilit'},{id:'silicone',name:'Silikon'}
    ].map(o=>`<option value=\"${o.id}\" ${selected===o.id?'selected':''}>${o.name}</option>`).join('');}
    function getProductName(v){return {
      'pvc-80':'PVC Pencere 80mm','pvc-70':'PVC Pencere 70mm','door-steel':'√áelik Kapƒ±','door-wooden':'Ah≈üap Kapƒ±',
      'glass-balcony':'Cam Balkon Sistemi','mosquito-net':'Sineklik','roller-shutter':'Motorlu Panjur','manual-shutter':'Manuel Panjur',
      'glass-4mm':'Cam 4mm','glass-6mm':'Cam 6mm','profile':'Profil','handle':'Kol','hinge':'Mente≈üe','lock':'Kilit','silicone':'Silikon'
    }[v]||v||'-';}
    function getCategoryName(v){return {
      'pvc-window':'PVC Pencere','door':'Kapƒ±','glass-balcony':'Cam Balkon','mosquito':'Sineklik','shutter':'Panjur','service':'Servis','other':'Diƒüer'
    }[v]||v||'-';}
    function getCustomerName(id){
      const c = CustomerService.customers.find(x => x.id === id);
      return c ? c.name : `M√º≈üteri (#${id})`;
    }

    window.handleFiles = function(key,e){
      const files=Array.from(e.target.files||[]);
      const mapped=files.map(f=>({id:String(Date.now()+Math.random()),name:f.name,size:f.size,type:f.type,previewUrl:f.type.startsWith('image/')?URL.createObjectURL(f):''}));
      wizardState.formData[key]=[...(wizardState.formData[key]||[]),...mapped];
      renderWizard();
    };
    window.removeFile = function(key,idx){wizardState.formData[key].splice(idx,1);renderWizard();};
    window.handleSingleFile = function(key,e){const f=e.target.files?.[0];if(!f)return;wizardState.formData[key]={id:String(Date.now()),name:f.name,size:f.size,type:f.type,previewUrl:''};renderWizard();};
    window.removeSingleFile = function(key){wizardState.formData[key]=null;renderWizard();};

    // customer search & modal (prompt-based mock)
    window.searchCustomer = function(){
      const q=val('#customerSearch'); const res=CustomerService.search(q);
      const ctn=document.getElementById('customerResults'); if(!ctn)return;
      ctn.innerHTML = res.map(c=>`<div style="padding:8px; border:1px solid var(--color-border); border-radius:8px; margin-top:6px; cursor:pointer;" onclick="selectCustomer('${c.id}')">${c.name} <span style="color:var(--color-text-light);">(${c.type})</span></div>`).join('') || '<span style="color:var(--color-text-light);">M√º≈üteri yok</span>';
    };
    window.selectCustomer=function(id){wizardState.formData.customerId=id;renderWizard();};
    window.openCustomerModal=function(){
      const name=prompt('M√º≈üteri adƒ±/√ºnvan'); if(!name)return;
      const type=confirm('Kurumsal mƒ±?')?'corporate':'individual';
      const phone=prompt('Telefon (opsiyonel)')||'';
      const city=prompt('ƒ∞l/ƒ∞l√ße (opsiyonel)')||'';
      const note=prompt('Not (opsiyonel)')||'';
      const c=CustomerService.add({name,type,phone,city,note});
      wizardState.formData.customerId=c.id;
      renderWizard();
    };

    window.addQuoteItem=function(){wizardState.formData.quoteItems.push({name:'',amount:0,type:'material',note:''});renderWizard();};
    window.removeQuoteItem=function(i){wizardState.formData.quoteItems.splice(i,1);renderWizard();};
    window.updateQuoteItem=function(i,f,v){if(!wizardState.formData.quoteItems[i])return;wizardState.formData.quoteItems[i][f]=f==='amount'?Number(v):v;};
    window.onQuoteStatusChange=function(v){wizardState.formData.quoteStatus=v;renderWizard();};

    window.addProduct=function(){wizardState.formData.products.push({name:'',unit:'adet',quantity:1,note:''});renderWizard();};
    window.removeProduct=function(i){wizardState.formData.products.splice(i,1);renderWizard();};
    window.updateProduct=function(i,f,v){if(!wizardState.formData.products[i])return;wizardState.formData.products[i][f]=f==='quantity'?Number(v):v;};

    window.addMeasurement=function(){wizardState.formData.measurements.push({type:'',width:0,height:0,quantity:1});renderWizard();};
    window.removeMeasurement=function(i){wizardState.formData.measurements.splice(i,1);renderWizard();};
    window.updateMeasurement=function(i,f,v){if(!wizardState.formData.measurements[i])return;wizardState.formData.measurements[i][f]=['quantity','width','height'].includes(f)?Number(v):v;};

    window.createPurchaseDraft=function(){
      const missing=(wizardState.formData.products||[]).filter(p=>mockStockStatus(p).label==='Yok').map(p=>({name:getProductName(p.name),qty:p.quantity,unit:p.unit||'adet'}));
      savePurchaseDraft(missing,wizardState.formData.supplierPreference,wizardState.formData.purchaseNote);
      wizardState.formData.needsPurchase='yes';
      if(!wizardState.formData.purchaseNote) wizardState.formData.purchaseNote='Eksik stok i√ßin otomatik taslak';
      showToast('Satƒ±nalma taslaƒüƒ± olu≈üturuldu','success');
      renderWizard();
    };
    window.markPurchaseNeeded=function(){wizardState.formData.needsPurchase='yes';renderWizard();};

    // Step change triggers
    window.onSurveyChange=function(v){
      wizardState.formData.needsSurvey=v;
      resolveFlow();
      syncUrlStep();
      renderWizard();
    };
    window.onCategoryChange=function(v){
      wizardState.formData.jobCategory=v;
      resolveFlow();
      syncUrlStep();
      renderWizard();
    };

    // attach global listeners (placeholder)
    function attachEventListeners(){ document.querySelectorAll('.form-input,.form-select,.form-textarea').forEach(el=>el.addEventListener('input',()=>hideValidationErrors())); }

    function showToast(msg,type='success'){
      const t=document.createElement('div'); t.className='toast';
      t.style.background=type==='success'?'var(--color-success)':type==='warning'?'var(--color-warning)':'var(--color-danger)';
      t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),3000);
    }
  </script>
</body>
</html>
